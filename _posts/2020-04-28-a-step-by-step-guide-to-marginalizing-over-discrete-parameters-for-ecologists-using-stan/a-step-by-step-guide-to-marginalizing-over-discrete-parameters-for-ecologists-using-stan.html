<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
  <title>A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan</title>
  
  <meta property="description" itemprop="description" content="Everything you might have been afraid to ask about implementing models with &#10;discrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing&#10;over partly observed presence/absence states in a simple occupancy model."/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2020-04-28"/>
  <meta property="article:created" itemprop="dateCreated" content="2020-04-28"/>
  <meta name="article:author" content="Maxwell B. Joseph"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Everything you might have been afraid to ask about implementing models with &#10;discrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing&#10;over partly observed presence/absence states in a simple occupancy model."/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan"/>
  <meta property="twitter:description" content="Everything you might have been afraid to ask about implementing models with &#10;discrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing&#10;over partly observed presence/absence states in a simple occupancy model."/>
  
  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Bayesian population analysis using winbugs: A hierarchical perspective;citation_publication_date=2011;citation_publisher=Academic Press;citation_author=Marc KÃ©ry;citation_author=Michael Schaub"/>
  <meta name="citation_reference" content="citation_title=Estimating site occupancy rates when detection probabilities are less than one;citation_publication_date=2002;citation_publisher=Wiley Online Library;citation_volume=83;citation_author=Darryl I MacKenzie;citation_author=James D Nichols;citation_author=Gideon B Lachman;citation_author=Sam Droege;citation_author=J Andrew Royle;citation_author=Catherine A Langtimm"/>
  <meta name="citation_reference" content="citation_title=Spatial capture-recapture;citation_publication_date=2013;citation_publisher=Academic Press;citation_author=J Andrew Royle;citation_author=Richard B Chandler;citation_author=Rahel Sollmann;citation_author=Beth Gardner"/>
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","bibliography"]}},"value":[{"type":"character","attributes":{},"value":["A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan"]},{"type":"character","attributes":{},"value":["Everything you might have been afraid to ask about implementing models with \ndiscrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing\nover partly observed presence/absence states in a simple occupancy model. \n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Maxwell B. Joseph"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":[]}},"value":[]}]}]},{"type":"character","attributes":{},"value":["04-28-2020"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["library.bib"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/bowser-1.9.3/bowser.min.js","a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/distill-2.2.21/template.v2.js","a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/jquery-1.11.3/jquery.min.js","a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/webcomponents-2.0.0/webcomponents.js","dag.png","dag.svg","library.bib","occupancy.stan"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for table of contents */
  
  .d-toc {
    color: rgba(0,0,0,0.8);
    font-size: 0.8em;
    line-height: 1em;
  }
  
  .d-toc-header {
    font-size: 0.6rem;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.5);
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.3em;
  }
  
  .d-toc a {
    border-bottom: none;
  }
  
  .d-toc ul {
    padding-left: 0;
  }
  
  .d-toc li>ul {
    padding-top: 0.8em;
    padding-left: 16px;
    margin-bottom: 0.6em;
  }
  
  .d-toc ul,
  .d-toc li {
    list-style-type: none;
  }
  
  .d-toc li {
    margin-bottom: 0.9em;
  }
  
  .d-toc-separator {
    margin-top: 20px;
    margin-bottom: 2em;
  }
  
  .d-article-with-toc {
    border-top: none;
    padding-top: 0;
  }
  
  
  
  /* Tweak code blocks (note that this CSS is repeated above in an injection
     into the d-code shadow dom) */
  
  d-code {
    overflow-x: auto !important;
  }
  
  pre.d-code code.d-code {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  pre.text-output {
  
    font-size: 12px;
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  @media(min-width: 768px) {
  
  d-code {
    overflow-x: visible !important;
  }
  
  pre.d-code code.d-code  {
      padding-left: 18px;
      font-size: 14px;
  }
  pre.text-output {
    font-size: 14px;
  }
  }
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // create d-bibliography
    var bibliography = $('<d-bibliography></d-bibliography>');
    $('#distill-bibliography').wrap(bibliography);
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace citations with <d-cite>
    $('.citation').each(function(i, val) {
      appendix = true;
      var cites = $(this).attr('data-cites').split(" ");
      var dt_cite = $('<d-cite></d-cite>');
      dt_cite.attr('key', cites.join());
      $(this).replaceWith(dt_cite);
    });
    // remove refs
    $('#refs').remove();
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-toc a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // replace code blocks with d-code
    $('pre>code').each(function(i, val) {
      var code = $(this);
      var pre = code.parent();
      var clz = "";
      var language = pre.attr('class');
      if (language) {
        // map unknown languages to "clike" (without this they just dissapear)
        if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                                 "javascript", "js", "julia", "lua", "markdown",
                                 "markup", "mathml", "python", "svg", "xml"]) == -1)
          language = "clike";
        language = ' language="' + language + '"';
        var dt_code = $('<d-code block' + language + clz + '></d-code>');
        dt_code.text(code.text());
        pre.replaceWith(dt_code);
      } else {
        code.addClass('text-output').unwrap().changeElementType('pre');
      }
    });
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('d-code, pre.text-output, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // table of contents
      if (have_authors) // adjust border if we are in authors
        $('.d-toc').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
      $('d-code').each(function(i, val) {
        var style = document.createElement('style');
        style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                          '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
        if (this.shadowRoot)
          this.shadowRoot.appendChild(style);
      });
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-toc-header').remove();
    $('.d-toc').remove();
    $('.d-toc-separator').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan","description":"Everything you might have been afraid to ask about implementing models with \ndiscrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing\nover partly observed presence/absence states in a simple occupancy model.","authors":[{"author":"Maxwell B. Joseph","authorURL":{},"affiliation":"&nbsp;","affiliationURL":"#"}],"publishedDate":"2020-04-28T00:00:00.000-06:00","citationText":"Joseph, 2020"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>A step-by-step guide to marginalizing over discrete parameters for ecologists using Stan</h1>
<p>Everything you might have been afraid to ask about implementing models with discrete parameters in Stan. Written for ecologists that know BUGS, JAGS, or NIMBLE, and want to use Stan. Provides an example by marginalizing over partly observed presence/absence states in a simple occupancy model.</p>
</div>

<div class="d-byline">
  Maxwell B. Joseph true 
  
<br/>04-28-2020
</div>

<div class="d-article">
<p>Discrete parameters can be a major stumbling block for ecologists using <a href="https://mc-stan.org/">Stan</a>, because you need to marginalize over the latent discrete parameters (e.g., âalive/deadâ, âoccupied/not occupiedâ, âinfected/not infectedâ, etc.). This post demonstrates how to do it, step by step for a simple example. Iâll try to make it clear what we are doing along the way, as we work towards a model that we can represent in Stan.</p>
<p>Consider a Bayesian site occupancy model. We want to estimate occurrence states (presence or absence) using observed detection/non-detection data <span class="citation" data-cites="mackenzie2002estimating">(MacKenzie et al. <a href="#ref-mackenzie2002estimating">2002</a>)</span>. For sites <span class="math inline">\(i=1, ...,N\)</span> we have <span class="math inline">\(K\)</span> replicate sampling occasions. On each sampling occasion, we visit site <span class="math inline">\(i\)</span> and look for a critter (a bug, a bird, a plant, etc.).</p>
<p>Represent the number of sampling occasions where we detected the critter at site <span class="math inline">\(i\)</span> as <span class="math inline">\(y_i\)</span>. So if we see the critter on two surveys, <span class="math inline">\(y_i = 2\)</span>.</p>
<p>We assume that if a site is occupied (<span class="math inline">\(z_i=1\)</span>), we detect the animal with probability <span class="math inline">\(p\)</span>. If a site is not occupied (<span class="math inline">\(z_i=0\)</span>), we canât observe it.</p>
<h2 id="how-a-bugsjagsnimble-user-might-write-the-model">How a BUGS/JAGS/NIMBLE user might write the model</h2>
<p>We can write the observation model for site <span class="math inline">\(i\)</span> as:</p>
<p><span class="math display">\[y_i \sim \text{Binomial}(K, p z_i).\]</span></p>
<aside>
This assumes that detections are independent across surveys <span class="math inline">\(k=1, ..., K\)</span>.
</aside>
<p>And our prior for the occupancy state of site <span class="math inline">\(i\)</span> is:</p>
<p><span class="math display">\[z_i \sim \text{Bernoulli}(\psi),\]</span></p>
<p>where <span class="math inline">\(\psi\)</span> is the probability of occupancy.</p>
<p>A Bayesian model specification is completed by assigning priors to the remaining parameters:</p>
<p><span class="math display">\[p \sim \text{Uniform}(0, 1),\]</span> <span class="math display">\[\psi \sim \text{Uniform}(0, 1).\]</span></p>
<h2 id="square-bracket-probability-notation">Square bracket probability notation</h2>
<p>Letâs rewrite the model in a different way. First, I want to introduce a different notation for our observation model:</p>
<p><span class="math display">\[[y_i \mid p, z_i] = \text{Binomial}(y_i \mid K, p z_i).\]</span></p>
<p>In this notation, square brackets represent probability mass or density functions (for discrete or continuous quantities, respectively). Here, <span class="math inline">\([y_i \mid p, z_i]\)</span> is the probability mass function of <span class="math inline">\(y_i\)</span> conditioned on the parameters <span class="math inline">\(p\)</span> and <span class="math inline">\(z_i\)</span>.</p>
<p>If we assume that the observations <span class="math inline">\(y_{1:N} = y_1, ..., y_N\)</span> for each site are conditionally independent, we can write the observation model for all sites <span class="math inline">\(1:N\)</span> as:</p>
<p><span class="math display">\[[y_{1:N} \mid p, z_{1:N}] = \prod_{i=1}^N [y_i \mid p, z_i],\]</span></p>
<p>which follows from the definition of the <a href="https://en.wikipedia.org/wiki/Joint_probability_distribution#Joint_distribution_for_independent_variables">joint distribution of independent random variables</a>.</p>
<p>We can rewrite the rest of the model in the same notation. The state model for site <span class="math inline">\(i\)</span> becomes:</p>
<p><span class="math display">\[[z_i \mid \psi] = \text{Bernoulli}(z_i \mid \psi).\]</span></p>
<p>And, again if we assume that the occupancy states for site <span class="math inline">\(i=1, ..., N\)</span> are conditionally independent, then we can write down the state model for all sites as:</p>
<p><span class="math display">\[[z_{1:N} \mid \psi] = \prod_{i=1}^N \text{Bernoulli}(z_i \mid \psi).\]</span></p>
<p>Finally, we can write the priors in square bracket notation:</p>
<p><span class="math display">\[[\psi] = \text{Uniform}(\psi \mid 0, 1),\]</span></p>
<p><span class="math display">\[[p] = \text{Uniform}(p \mid 0, 1).\]</span></p>
<h2 id="writing-the-joint-distribution">Writing the joint distribution</h2>
<p>We are working towards a model specification that we can use in Stan, which means we need the <strong>log of the joint distribution of data and parameters</strong>.</p>
<aside>
If you just mouthed the words âwhat the ****â, stay with me.
</aside>
<p>The âjoint distribution of data and parametersâ is the numerator in Bayesâ theorem, which gives us an expression for the posterior probability distribution of parameters <span class="math inline">\(\theta\)</span> given data <span class="math inline">\(y\)</span>:</p>
<p><span class="math display">\[[\theta \mid y] = \dfrac{[y, \theta]}{[y]}.\]</span></p>
<p>In this example, our parameters <span class="math inline">\(\theta\)</span> are:</p>
<ul>
<li><span class="math inline">\(z_{1:N}\)</span>: the occupancy states</li>
<li><span class="math inline">\(p\)</span>: the detection probability</li>
<li><span class="math inline">\(\psi\)</span>: the occupancy probability</li>
</ul>
<p>The data consist of the counts <span class="math inline">\(y_{1:N}\)</span>.</p>
<p>So our joint distribution is:</p>
<p><span class="math display">\[[y_{1:N}, \theta] = [y_{1:N}, z_{1:N}, p, \psi],\]</span></p>
<p>We can factor this using the rules of conditional probability and the components we worked out in the previous section. First, recognize that:</p>
<ol type="1">
<li><span class="math inline">\(y\)</span> depends on <span class="math inline">\(p\)</span> and <span class="math inline">\(z\)</span>,</li>
<li><span class="math inline">\(z\)</span> depends on <span class="math inline">\(\psi\)</span>, and</li>
<li><span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span> donât depend on any other parameters:</li>
</ol>
<p><span class="math display">\[[y_{1:N}, z_{1:N}, p, \psi] = [y_{1:N} \mid p, z_{1:N}] \times [z_{1:N} \mid \psi] \times [p, \psi].\]</span></p>
<p>Then, recall that we can represent the joint probability distribution for the capture histories and states as a product of site-specific terms:</p>
<p><span class="math display">\[[y_{1:N}, z_{1:N}, p, \psi] = \prod_{i=1}^N [y_i \mid p, z_i] \times \prod_{i=1}^N [z_i \mid \psi] \times [p, \psi].\]</span></p>
<p>We can simplify this a little:</p>
<p><span class="math display">\[[y_{1:N}, z_{1:N}, p, \psi] = \prod_{i=1}^N [y_i \mid p, z_i] [z_i \mid \psi] \times [p, \psi].\]</span></p>
<p>Last, we have independent priors for <span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span>, so we can write the joint distribution as:</p>
<p><span class="math display">\[[y_{1:N}, z_{1:N}, p, \psi] = \prod_{i=1}^N [y_i \mid p, z_i] [z_i \mid \psi] \times [p] [\psi].\]</span></p>
<aside>
This follows from the definition of independent random variables. If <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> are independent, <span class="math inline">\([A, B] = [A] \times [B]\)</span>.
</aside>
<p>In case that is confusing, it can also be useful to visualize this same dependence structure graphically.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:plot"></span>
<img src="dag.png" alt="A directed acyclic graph for an occupancy model. Arrows represent dependence (e.g., p -&gt; y means y depends on p)." width="426" />
<p class="caption">
Figure 1: A directed acyclic graph for an occupancy model. Arrows represent dependence (e.g., p -&gt; y means y depends on p).
</p>
</div>
</div>
<p>This is <em>almost</em> in a form that we can use in Stan. But we need to get rid of <span class="math inline">\(z\)</span> from the model. Itâs a discrete parameter, and Stan needs continuous parameters.</p>
<h2 id="marginalizing-over-discrete-parameters">Marginalizing over discrete parameters</h2>
<p>To get rid of our discrete parameter <span class="math inline">\(z\)</span>, we need to <strong>marginalize</strong> it out of the model. In general, if you have a joint distribution for <span class="math inline">\(y\)</span> and <span class="math inline">\(z\)</span> that depends on <span class="math inline">\(\theta\)</span>, you obtain the marginal distribution of <span class="math inline">\(y\)</span> by summing the joint distribution over all possible values of <span class="math inline">\(z\)</span>:</p>
<p><span class="math display">\[[y \mid \theta] = \sum_{z} [y, z \mid \theta].\]</span></p>
<aside>
This is sometimes referred to as âsumming out the responsibility parameterâ. See why?
</aside>
<p>In our case, for the <span class="math inline">\(i^{th}\)</span> site, this means that we need to marginalize over <span class="math inline">\(z_i\)</span> as follows:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = \sum_{z_i=0}^1 [y_i, z_i \mid p, \psi].\]</span></p>
<p>We are summing over <strong>all possible values</strong> of <span class="math inline">\(z_i\)</span>. In this case there are two (<span class="math inline">\(z_i\)</span> can be 0 or 1).</p>
<p>We can factor the joint distribution:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = \sum_{z_i=0}^1 [y_i \mid p, z_i] [z_i \mid \psi].\]</span></p>
<p>This is:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = [y_i \mid p, z_i=0] [z_i=0 \mid \psi] + [y_i \mid p, z_i=1] [z_i=1 \mid \psi].\]</span></p>
<p>Earlier we said <span class="math inline">\(\psi\)</span> is the probability that <span class="math inline">\(z_i = 1\)</span>. So, <span class="math inline">\(1-\psi\)</span> is the probability that <span class="math inline">\(z_i=0\)</span>:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = (1 - \psi) [y_i \mid p, z_i=0] + \psi [y_i \mid p, z_i=1].\]</span></p>
<aside>
Replace <span class="math inline">\([z_i=0 \mid \psi]\)</span> with <span class="math inline">\(1-\psi\)</span>, and <span class="math inline">\([z_i=1 \mid \psi]\)</span> with <span class="math inline">\(\psi\)</span>.
</aside>
<p>We can also simplify the observation model for unoccupied sites. Because we assume that there are no false positive detections, unoccupied sites (<span class="math inline">\(z_i=0\)</span>) can only generate zero counts for <span class="math inline">\(y_i\)</span> (or, you could say that <span class="math inline">\(y_i\)</span> is identically zero if <span class="math inline">\(z_i=0\)</span>). We can then write this as:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = (1 - \psi) I(y_i=0) + \psi [y_i \mid p, z_i=1],\]</span></p>
<p>where <span class="math inline">\(I(y_i=0)\)</span> is an indicator function that is equal to one if <span class="math inline">\(y_i=0\)</span>, and otherwise is equal to zero.</p>
<p>It might be more intuitive to write this as:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = \begin{cases}
        \psi [y_i \mid p, z_i=1], &amp; \text{for } y_i &gt; 0\\
        \psi [y_i \mid p, z_i=1] + 1 - \psi, &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>We can make this even more explicit by bringing back in the fact that our probability model for <span class="math inline">\(y_i\)</span> is Binomial:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = \begin{cases}
        \psi \text{Binomial}(y_i \mid p), &amp; \text{for } y_i &gt; 0\\
        \psi \text{Binomial}(y_i \mid p) + 1 - \psi, &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>Great - we just marginalized <span class="math inline">\(z_i\)</span> out of the model.</p>
<p>Letâs circle back to the joint distribution and see what it looks like now. Previously we had:</p>
<p><span class="math display">\[[y_{1:N}, z_{1:N}, p, \psi] = \prod_{i=1}^N [y_i \mid p, z_i] [z_i \mid \psi] \times [p] [\psi].\]</span></p>
<p>Now, if we marginalize over <span class="math inline">\(z\)</span> for every site, weâd be computing:</p>
<p><span class="math display">\[[y_{1:N}, p, \psi] = \prod_{i=1}^N \Big( \sum_{z_i=0}^1 [y_i \mid p, z_i] [z_i \mid \psi] \Big) \times [p] [\psi],\]</span> <span class="math display">\[ = \prod_{i=1}^N [y_i \mid p, \psi] \times [p] [\psi].\]</span></p>
<p>This joint distribution is something we can work with in Stan. The last thing we need to do is write down the <strong>log of the joint distribution</strong>, and translate that into Stanâs syntax.</p>
<h2 id="the-log-of-the-joint-distribution">The log of the joint distribution</h2>
<p>We are going to specify the joint distribution in Stan on the log scale. Take the log of our joint distribution:</p>
<p><span class="math display">\[\log([y_{1:N}, p, \psi]) = \log \Bigg(\prod_{i=1}^N [y_i \mid p, \psi] \times [p] [\psi] \Bigg),\]</span></p>
<p>and by â<span class="math inline">\(\log\)</span>â I mean the natural log.</p>
<p>Recall that the log of a product is the sum of logs: <span class="math inline">\(\log(ab) = \log(a) + \log(b)\)</span>). We can apply this rule and find that:</p>
<p><span class="math display">\[\log([y_{1:N}, p, \psi]) = \sum_{i=1}^N \log [y_i \mid p, \psi] + \log[p] + \log[\psi].\]</span></p>
<p>Letâs think about how to represent <span class="math inline">\(\log [y_i \mid p, \psi]\)</span>. Recall from before that:</p>
<p><span class="math display">\[[y_i \mid p, \psi] = \begin{cases}
        \psi \text{Binomial}(y_i \mid p), &amp; \text{for } y_i &gt; 0\\
        \psi \text{Binomial}(y_i \mid p) + 1 - \psi, &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>Taking logarithms, we get:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \big( \psi \text{Binomial}(y_i \mid p) \big), &amp; \text{for } y_i &gt; 0\\
        \log \big( \psi \text{Binomial}(y_i \mid p) + 1 - \psi \big), &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>Recalling rules about logs of products, we can rewrite this as:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \log(\text{Binomial}(y_i \mid p)), &amp; \text{for } y_i &gt; 0\\
        \log \big( \psi \text{Binomial}(y_i \mid p) + 1 - \psi \big), &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>Stan has a function called <a href="https://mc-stan.org/docs/2_21/functions-reference/binomial-distribution.html"><code>binomial_lpmf</code></a> (âbinomial log probability mass functionâ) that gives us exactly what we need to compute <span class="math inline">\(\log(\text{Binomial}(y_i \mid p))\)</span> above. To make this connection clear, letâs rewrite this as:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \text{binomial_lpmf}(y_i \mid p), &amp; \text{for } y_i &gt; 0\\
        \log \big( \psi \text{Binomial}(y_i \mid p) + 1 - \psi \big), &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<p>First, letâs do write the case where <span class="math inline">\(y_i=0\)</span> as:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \text{binomial_lpmf}(y_i \mid p), &amp; \text{for } y_i &gt; 0\\
        \log \big( e^{\log(\psi \text{Binomial}(y_i \mid p))} + e^{\log(1 - \psi)} \big), &amp; \text{for } y_i = 0
        \end{cases}\]</span></p>
<aside>
It may seem silly to do this, but trust me it will be useful.
</aside>
<p>This is true because <span class="math inline">\(e^{\log(x)=x}\)</span>.</p>
<p>Then, apply the rule about <span class="math inline">\(\log(ab) = \log a + \log b\)</span> again:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \text{binomial_lpmf}(y_i \mid p), &amp; \text{for } y_i &gt; 0\\
        \log \big( e^{\log \psi + \text{binomial_lpmf}(y_i \mid p)} + e^{\log(1 - \psi)} \big), &amp; \text{for } y_i = 0
        \end{cases}
\]</span></p>
<p>At this point, we are going to bring in the <a href="https://en.wikipedia.org/wiki/LogSumExp">LogSumExp</a> trick, which gives us a computationally stable way to compute terms like <span class="math inline">\(\log(\sum_i \exp(x_i))\)</span>. Stan has a function called <a href="https://mc-stan.org/docs/2_18/stan-users-guide/summing-out-the-responsibility-parameter.html"><code>log_sum_exp</code></a> that does this for us, and it takes the terms to sum on the log scale as inputs.</p>
<p>Letâs rewrite the model for the data with this function:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \text{binomial_lpmf}(y_i \mid p), &amp;  y_i &gt; 0\\
        \text{log_sum_exp}(\log \psi + \text{binomial_lpmf}(y_i \mid p),\; \log(1 - \psi)), &amp;  y_i = 0
        \end{cases}
\]</span></p>
<h2 id="translating-our-model-to-stan">Translating our model to Stan</h2>
<p>Hereâs the Stan model (written for clarity, not computational efficiency):</p>
<pre class="stan"><code>
data {
  int&lt;lower = 1&gt; N;
  int&lt;lower = 1&gt; K;
  int&lt;lower = 0, upper = K&gt; y[N];
}

parameters {
  real&lt;lower = 0, upper = 1&gt; p;
  real&lt;lower = 0, upper = 1&gt; psi;
}

transformed parameters {
  vector[N] log_lik;
  
  for (i in 1:N) {
    if (y[i] &gt; 0) {
      log_lik[i] = log(psi) + binomial_lpmf(y[i] | K, p);
    } else {
      log_lik[i] = log_sum_exp(
        log(psi) + binomial_lpmf(y[i] | K, p), 
        log1m(psi)
      );
    }
  }
}

model {
  target += sum(log_lik);
  target += uniform_lpdf(p | 0, 1);
  target += uniform_lpdf(psi | 0, 1);
}</code></pre>
<h3 id="the-observation-model">The observation model</h3>
<p>We symbolically represented the observation model as:</p>
<p><span class="math display">\[\log [y_i \mid p, \psi] = \begin{cases}
        \log \psi + \text{binomial_lpmf}(y_i \mid p), &amp;  y_i &gt; 0\\
        \text{log_sum_exp}(\log \psi + \text{binomial_lpmf}(y_i \mid p),\; \log(1 - \psi)), &amp;  y_i = 0
        \end{cases}\]</span></p>
<p>In Stan syntax, we are storing <span class="math inline">\(\log [y_i \mid p, \psi]\)</span> in the <span class="math inline">\(i^{th}\)</span> element of the vector <code>log_lik</code>. We used an if-statement to deal with the different cases:</p>
<pre class="stan"><code>
...
    if (y[i] &gt; 0) {
      log_lik[i] = log(psi) + binomial_lpmf(y[i] | K, p);
    } else {
      log_lik[i] = log_sum_exp(
        log(psi) + binomial_lpmf(y[i] | K, p), 
        log1m(psi)
      );
    }
...</code></pre>
<h3 id="the-log-joint-distribution-and-target">The log joint distribution and <code>target +=</code></h3>
<p>Notice how in the model block, we used <code>target +=</code> syntax to add things to the log joint distribution:</p>
<pre class="stan"><code>
...
model {
  target += sum(log_lik);
  target += uniform_lpdf(p | 0, 1);
  target += uniform_lpdf(psi | 0, 1);
}
...</code></pre>
<p>These terms correspond to the log joint distribution that we represented symbolically as</p>
<p><span class="math display">\[\log([y_{1:N}, p, \psi]) = \sum_{i=1}^N \log [y_i \mid p, \psi] + \log[p] + \log[\psi].\]</span></p>
<h2 id="bringing-it-all-together">Bringing it all together</h2>
<p>To recap, to go from our model specification with discrete parameters to a model that we can use in Stan, we did the following:</p>
<ol type="1">
<li>Wrote the joint distribution of our model</li>
<li>Marginalized discrete parameter(s) out of the joint distribution</li>
<li>Took the log of the joint distribution</li>
<li>Translated the log of the joint distribution into Stan code</li>
</ol>
<p>This general approach applies to a variety of models, but occupancy models provide a simple example.</p>
<h2 id="more-resources">More resources</h2>
<ul>
<li>The Stan documentation has some great content on marginalization of discrete parameters: <a href="https://mc-stan.org/docs/2_18/stan-users-guide/latent-discrete-parameterization.html" class="uri">https://mc-stan.org/docs/2_18/stan-users-guide/latent-discrete-parameterization.html</a></li>
<li>There are a ton of ecological models with discrete parameters that Hiroki ItÃ´ has translated to Stan from the book âBayesian Population Analysis using WinBUGS â A Hierarchical Perspectiveâ (2012) by Marc KÃ©ry and Michael Schaub <span class="citation" data-cites="kery2011bayesian">(KÃ©ry and Schaub <a href="#ref-kery2011bayesian">2011</a>)</span>: <a href="https://github.com/stan-dev/example-models/tree/master/BPA" class="uri">https://github.com/stan-dev/example-models/tree/master/BPA</a></li>
<li>Most of the example spatial capture-recapture models from the 2013 book <a href="https://www.elsevier.com/books/spatial-capture-recapture/royle/978-0-12-405939-9">Spatial Capture-Recapture</a> by Royle, Chandler, Gardner, and Sollmann <span class="citation" data-cites="royle2013spatial">(Royle et al. <a href="#ref-royle2013spatial">2013</a>)</span> have also been translated to Stan: <a href="https://github.com/mbjoseph/scr-stan" class="uri">https://github.com/mbjoseph/scr-stan</a></li>
<li>This post demonstrated how to marginalize symbolically (or âon paperâ I guess), but there is another great blog post by Jacob Socolar that focuses on JAGS to Stan code translation (and includes a marginal model implementation in JAGS): <a href="https://github.com/jsocolar/occupancyModels" class="uri">https://github.com/jsocolar/occupancyModels</a></li>
</ul>
<div id="refs" class="references">
<div id="ref-kery2011bayesian">
<p>KÃ©ry, Marc, and Michael Schaub. 2011. <em>Bayesian Population Analysis Using Winbugs: A Hierarchical Perspective</em>. Academic Press.</p>
</div>
<div id="ref-mackenzie2002estimating">
<p>MacKenzie, Darryl I, James D Nichols, Gideon B Lachman, Sam Droege, J Andrew Royle, and Catherine A Langtimm. 2002. âEstimating Site Occupancy Rates When Detection Probabilities Are Less Than One.â <em>Ecology</em> 83 (8): 2248â55.</p>
</div>
<div id="ref-royle2013spatial">
<p>Royle, J Andrew, Richard B Chandler, Rahel Sollmann, and Beth Gardner. 2013. <em>Spatial Capture-Recapture</em>. Academic Press.</p>
</div>
</div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<script id="distill-bibliography" type="text/bibtex">
@book{kery2011bayesian,
  title={Bayesian population analysis using WinBUGS: a hierarchical perspective},
  author={K{\'e}ry, Marc and Schaub, Michael},
  year={2011},
  publisher={Academic Press}
}

@article{mackenzie2002estimating,
  title={Estimating site occupancy rates when detection probabilities are less than one},
  author={MacKenzie, Darryl I and Nichols, James D and Lachman, Gideon B and Droege, Sam and Andrew Royle, J and Langtimm, Catherine A},
  journal={Ecology},
  volume={83},
  number={8},
  pages={2248--2255},
  year={2002},
  publisher={Wiley Online Library}
}

@book{royle2013spatial,
  title={Spatial capture-recapture},
  author={Royle, J Andrew and Chandler, Richard B and Sollmann, Rahel and Gardner, Beth},
  year={2013},
  publisher={Academic Press}
}
</script>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
